<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Documentación del Sistema de Gestión Documental MCS"><meta name="keywords" content="JSDoc, Documentation, SGD, MCS, Apps Script"><title>Source: Database.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><a href="/" class="sidebar-title sidebar-title-anchor">SGD-MCS Doc</a><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#CONFIG">CONFIG</a></div><div class="sidebar-section-children"><a href="global.html#SPREADSHEET_ID">SPREADSHEET_ID</a></div><div class="sidebar-section-children"><a href="global.html#actualizarMasivo">actualizarMasivo</a></div><div class="sidebar-section-children"><a href="global.html#configurarHoja">configurarHoja</a></div><div class="sidebar-section-children"><a href="global.html#crearEstructuraCompleta">crearEstructuraCompleta</a></div><div class="sidebar-section-children"><a href="global.html#crearHojaConfiguracion">crearHojaConfiguracion</a></div><div class="sidebar-section-children"><a href="global.html#crearHojaDocentes">crearHojaDocentes</a></div><div class="sidebar-section-children"><a href="global.html#crearHojaEstudiantes">crearHojaEstudiantes</a></div><div class="sidebar-section-children"><a href="global.html#crearHojaEventos">crearHojaEventos</a></div><div class="sidebar-section-children"><a href="global.html#crearHojaExternos">crearHojaExternos</a></div><div class="sidebar-section-children"><a href="global.html#crearHojaInstituciones">crearHojaInstituciones</a></div><div class="sidebar-section-children"><a href="global.html#crearHojaTesis">crearHojaTesis</a></div><div class="sidebar-section-children"><a href="global.html#eliminarMasivo">eliminarMasivo</a></div><div class="sidebar-section-children"><a href="global.html#enriquecerDatosConNombres">enriquecerDatosConNombres</a></div><div class="sidebar-section-children"><a href="global.html#formatearEmail">formatearEmail</a></div><div class="sidebar-section-children"><a href="global.html#formatearNombrePropio">formatearNombrePropio</a></div><div class="sidebar-section-children"><a href="global.html#formatearTextoCapital">formatearTextoCapital</a></div><div class="sidebar-section-children"><a href="global.html#formatearTextoGeneral">formatearTextoGeneral</a></div><div class="sidebar-section-children"><a href="global.html#generarSiguienteId">generarSiguienteId</a></div><div class="sidebar-section-children"><a href="global.html#getDB">getDB</a></div><div class="sidebar-section-children"><a href="global.html#getModuleHeaders">getModuleHeaders</a></div><div class="sidebar-section-children"><a href="global.html#guardarDatos">guardarDatos</a></div><div class="sidebar-section-children"><a href="global.html#obtenerDatosHoja">obtenerDatosHoja</a></div><div class="sidebar-section-children"><a href="global.html#obtenerDatosIniciales">obtenerDatosIniciales</a></div><div class="sidebar-section-children"><a href="global.html#obtenerHoja">obtenerHoja</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">Database.js</h1></header><article><pre class="prettyprint source lang-js"><code>/**
 * @file Code.gs
 * @overview Funciones de Google Apps Script para gestionar datos en una hoja de cálculo como backend para un sistema de gestión documental.
 */

/**
 * @function obtenerDatosHoja
 * @description Obtiene datos de una hoja de Google específica. Recupera todos los valores, limpia encabezados y procesa cada fila en un objeto. Incluye manejo especial para campos de 'cohorte' y formatea fechas como 'YYYY-MM-DD'. Filtra filas vacías.
 * @param {string} n El nombre de la hoja de la cual obtener datos.
 * @returns {Array&lt;Object>} Un array de objetos, donde cada objeto representa una fila de datos con claves correspondientes a los encabezados de la hoja.
 */
function obtenerDatosHoja(n) {
    const s = obtenerHoja(n);
    const d = s.getDataRange().getValues();
    if (d.length &lt;= 1) return [];

    const h = d[0].map(x => String(x).trim());

    return d.slice(1).map(r => {
        const o = {};
        h.forEach((k, i) => {
            let v = r[i];

            // Special handling for 'cohorte' as text, Dates as YYYY-MM-DD
            if (k.toLowerCase().includes('cohorte')) {
                if (v instanceof Date) v = v.getFullYear() + "-" + (v.getMonth() + 1);
                else v = String(v);
            }
            else if (v instanceof Date) {
                v = Utilities.formatDate(v, Session.getScriptTimeZone(), "yyyy-MM-dd");
            }

            o[k] = (v === undefined || v === null) ? "" : v;
        });
        return o;
    }).filter(o => o[h[0]] &amp;&amp; String(o[h[0]]).trim() !== "");
}

/**
 * @function obtenerDatosIniciales
 * @description Recupera los datos iniciales de varios módulos (estudiantes, docentes, tesis, eventos, instituciones, externos) llamando a `obtenerDatosHoja` para cada hoja configurada.
 * @returns {Object} Objeto que contiene un estado de éxito y un objeto de datos con propiedades para cada módulo.
 */
function obtenerDatosIniciales() {
    return {
        success: true, data: {
            estudiantes: obtenerDatosHoja(CONFIG.SHEETS.ESTUDIANTES),
            docentes: obtenerDatosHoja(CONFIG.SHEETS.DOCENTES),
            tesis: obtenerDatosHoja(CONFIG.SHEETS.TESIS),
            eventos: obtenerDatosHoja(CONFIG.SHEETS.EVENTOS),
            instituciones: obtenerDatosHoja(CONFIG.SHEETS.INSTITUCIONES),
            externos: obtenerDatosHoja(CONFIG.SHEETS.EXTERNOS)
        }
    };
}

/**
 * @function formatearTextoCapital
 * @description Formatea una cadena de texto en formato Título (primera letra de cada palabra en mayúscula). Si la entrada es nula o vacía, devuelve una cadena vacía.
 * @param {string} texto La cadena de texto a formatear.
 * @returns {string} La cadena de texto formateada.
 */
function formatearTextoCapital(texto) {
    if (!texto) return "";
    return String(texto).toLowerCase().replace(/(?:^|\s|['"({])+[a-z]/g, (l) => l.toUpperCase());
}

/**
 * @function enriquecerDatosConNombres
 * @description Enriquece los objetos de datos con nombres legibles resolviendo los IDs de hojas relacionadas. Utiliza una caché para mayor eficiencia. Especializada para las hojas de 'EVENTOS' y 'TESIS'.
 * @param {string} sheetKey La clave de la hoja actual (ej. 'EVENTOS', 'TESIS').
 * @param {Object} data El objeto de datos a enriquecer.
 * @returns {Object} El objeto de datos enriquecido.
 */
function enriquecerDatosConNombres(sheetKey, data) {
    const cache = {};

    /**
     * @description Función auxiliar para obtener un mapa de IDs a nombres para una hoja específica.
     * @param {string} hoja La clave de la hoja para la cual crear el mapa.
     * @param {string} idKey La clave que representa el ID en los datos.
     * @param {Array&lt;string>} nameKeys Array de claves que representan las partes del nombre.
     * @returns {Object} Un mapa donde las claves son IDs y los valores son los nombres correspondientes.
     */
    function getMap(hoja, idKey, nameKeys) {
        if (!cache[hoja]) {
            const raw = obtenerDatosHoja(CONFIG.SHEETS[hoja]);
            cache[hoja] = {};
            raw.forEach(r => {
                let nombre = nameKeys.map(k => r[k]).join(' ').trim();
                if (nameKeys.length === 1) nombre = r[nameKeys[0]];
                cache[hoja][r[idKey]] = nombre;
            });
        } return cache[hoja];
    }

    /**
     * @description Función auxiliar para resolver múltiples IDs en una cadena separada por comas a sus nombres correspondientes.
     * @param {string} idsStr Cadena de IDs separados por comas.
     * @param {string} hoja Clave de la hoja donde resolver los IDs.
     * @param {string} idKey La clave del ID en la hoja destino.
     * @param {Array&lt;string>} nameKeys Las claves del nombre en la hoja destino.
     * @returns {string} Cadena de nombres resueltos separados por comas.
     */
    function resolverNombres(idsStr, hoja, idKey, nameKeys) {
        if (!idsStr) return "";
        const mapa = getMap(hoja, idKey, nameKeys);
        return String(idsStr).split(',').map(id => mapa[id.trim()] || id).join(', ');
    }

    /**
     * @description Función auxiliar para resolver un solo ID a su nombre correspondiente.
     * @param {string} id El ID a resolver.
     * @param {string} hoja Clave de la hoja donde resolver el ID.
     * @param {string} idKey La clave del ID en la hoja destino.
     * @param {Array&lt;string>} nameKeys Las claves del nombre en la hoja destino.
     * @returns {string} El nombre resuelto o el ID original si no se encuentra.
     */
    function resolverUnNombre(id, hoja, idKey, nameKeys) {
        if (!id) return "";
        const mapa = getMap(hoja, idKey, nameKeys);
        return mapa[id] || id;
    }

    if (sheetKey === 'EVENTOS') {
        if (data['IDs_Estudiantes_Asistentes']) data['Nombres_Estudiantes_Asistentes'] = resolverNombres(data['IDs_Estudiantes_Asistentes'], 'ESTUDIANTES', 'ID_Estudiante', ['Nombre1', 'Apellido1']);
        if (data['IDs_Docentes_Participantes']) data['Nombres_Docentes_Participantes'] = resolverNombres(data['IDs_Docentes_Participantes'], 'DOCENTES', 'ID_Docente', ['Nombre1', 'Apellido1']);
        if (data['IDs_Externos_Participantes']) data['Nombres_Externos_Participantes'] = resolverNombres(data['IDs_Externos_Participantes'], 'EXTERNOS', 'ID_Externo', ['Nombre1', 'Apellido1']);
        if (data['IDs_Instituciones']) data['Nombres_Instituciones'] = resolverNombres(data['IDs_Instituciones'], 'INSTITUCIONES', 'ID_Institucion', ['Nombre_Institucion']);
        if (data['IDs_Tesis_Vinculadas']) data['Titulos_Tesis_Vinculadas'] = resolverNombres(data['IDs_Tesis_Vinculadas'], 'TESIS', 'ID_Tesis', ['Titulo_Investigacion']);
    }
    if (sheetKey === 'TESIS') {
        const mapDoc = getMap('DOCENTES', 'ID_Docente', ['Nombre1', 'Apellido1']);
        const getName = (id) => mapDoc[id] || id;
        if (data['Codirector']) data['Nombre_Codirector'] = getName(data['Codirector']);
        if (data['Jurado_1']) data['Nombre_Jurado_1'] = getName(data['Jurado_1']);
        if (data['Jurado_2']) data['Nombre_Jurado_2'] = getName(data['Jurado_2']);
        if (data['ID_Asesor']) data['Nombre_Asesor'] = getName(data['ID_Asesor']);
        if (data['ID_Estudiante']) data['Nombre_Estudiante'] = resolverUnNombre(data['ID_Estudiante'], 'ESTUDIANTES', 'ID_Estudiante', ['Nombre1', 'Apellido1']);
    }
    return data;
}

/**
 * @function guardarDatos
 * @description Guarda datos en la hoja de Google correspondiente, gestionando tanto nuevos registros como actualizaciones. Realiza normalización de campos (ej. email a minúsculas, nombres a formato título), valida datos (ej. ID numérico, duplicados) y enriquece los datos antes de guardar. Genera IDs para nuevos registros y establece marcas de tiempo.
 * @param {string} modulo El nombre del módulo (ej. 'ESTUDIANTE', 'DOCENTE').
 * @param {Object} data El objeto de datos a guardar o actualizar.
 * @returns {Object} Objeto que indica éxito o fallo y un mensaje.
 */
function guardarDatos(modulo, data) {
    try {
        let sheetKey;
        const mu = String(modulo).toUpperCase();
        if (mu.startsWith('ESTUDIANTE')) sheetKey = 'ESTUDIANTES';
        else if (mu.startsWith('DOCENTE')) sheetKey = 'DOCENTES';
        else if (mu.startsWith('TESIS')) sheetKey = 'TESIS';
        else if (mu.startsWith('EVENTO')) sheetKey = 'EVENTOS';
        else if (mu.startsWith('INSTITUCION')) sheetKey = 'INSTITUCIONES';
        else if (mu.startsWith('EXTERNO')) sheetKey = 'EXTERNOS';
        else throw new Error(`Módulo ${modulo} no reconocido.`);

        const sheetName = CONFIG.SHEETS[sheetKey];
        const sheet = obtenerHoja(sheetName);
        const headers = getModuleHeaders(sheet);
        const primaryKey = headers[0];
        const allData = sheet.getDataRange().getValues();
        const esActualizacion = (data.ID &amp;&amp; String(data.ID).trim() !== "");

        // --- A. GLOBAL FIELD NORMALIZATION --- 
        // Iterate over ALL incoming fields to clean them
        Object.keys(data).forEach(key => {
            let val = data[key];
            if (typeof val === 'string' &amp;&amp; val.trim() !== "") {
                // 1. Emails always lowercase
                if (key.toLowerCase().includes('email') || key.toLowerCase().includes('correo')) {
                    data[key] = val.toLowerCase().trim().replace(/\s/g, '');
                }
                // 2. URLs and IDs are not touched
                else if (key.startsWith('URL') || key.startsWith('Link') || key.startsWith('ID') || key.includes('Cohorte')) {
                    data[key] = val.trim();
                }
                // 3. Long paragraphs (Comments/Description) only trim, not Capitalize to avoid damaging grammar
                else if (['Comentarios', 'Descripcion', 'Resumen', 'Perfil_Externos', 'Impacto_Academico'].includes(key)) {
                    data[key] = val.trim();
                }
                // 4. EVERYTHING ELSE (Names, Cities, Positions, etc.) -> Title Case
                else {
                    data[key] = formatearTextoCapital(val);
                }
            }
        });

        // --- B. SECURITY VALIDATIONS ---
        // 1. Numeric ID (Except Passport)
        if ((sheetKey === 'DOCENTES' || sheetKey === 'ESTUDIANTES') &amp;&amp; data.Cedula) {
            if ((data.Tipo_Documento === 'CC' || data.Tipo_Documento === 'TI') &amp;&amp; !/^\d+$/.test(data.Cedula)) {
                return {
                    success: false, message: "⛔ Cédula debe ser numérica para CC/TI"
                };
            }
        }

        // 2. DUPLICATE DETECTION (DOCUMENT AND EMAIL)
        // Define which columns cannot be repeated
        const camposUnicos = [];
        if (sheetKey === 'ESTUDIANTES' || sheetKey === 'DOCENTES') {
            camposUnicos.push({ col: 'Cedula', msg: 'La Cédula' });
            camposUnicos.push({ col: 'Email', msg: 'El Email' });
        } else if (sheetKey === 'EXTERNOS') {
            camposUnicos.push({ col: 'Numero_Documento', msg: 'El Documento' });
            camposUnicos.push({ col: 'Email', msg: 'El Email' });
        } else if (sheetKey === 'INSTITUCIONES') {
            camposUnicos.push({ col: 'Nombre_Institucion', msg: 'La Institución' });
        }

        // Verification
        if (camposUnicos.length > 0) {
            for (let i = 1; i &lt; allData.length; i++) {
                const idFila = String(allData[i][0]);
                if (esActualizacion &amp;&amp; idFila === String(data.ID)) continue; // Skip itself

                for (const campo of camposUnicos) {
                    const idx = headers.indexOf(campo.col);
                    if (idx !== -1) {
                        const valorEnBD = String(allData[i][idx] || '').trim().toLowerCase();
                        const valorNuevo = String(data[campo.col] || '').trim().toLowerCase();

                        if (valorNuevo &amp;&amp; valorEnBD === valorNuevo) {
                            return { success: false, message: `⛔ Error: ${campo.msg} '${data[campo.col]}' ya existe en el sistema.` };
                        }
                    }
                }
            }
        }

        data = enriquecerDatosConNombres(sheetKey, data);

        // --- C. SAVING --- 
        let fila = -1;

        if (esActualizacion) {
            for (let i = 1; i &lt; allData.length; i++) { if (String(allData[i][0]).trim() === String(data.ID).trim()) { fila = i + 1; break; } }
            if (fila === -1) return { success: false, message: "ID no encontrado para actualizar" };
        } else {
            data[primaryKey] = generarSiguienteId(sheetName);
        }

        const rowData = headers.map(h => {
            let val = data[h];
            if (h === 'Fecha_Registro' &amp;&amp; !esActualizacion) return new Date();
            if (h === 'Ultima_Actualizacion') return new Date();
            if (h === 'Fecha_Registro' &amp;&amp; esActualizacion) return undefined; // Keep existing date on update
            if (val === undefined &amp;&amp; esActualizacion) return undefined; // Preserve existing value if not provided for update
            if (val === undefined) return ""; // Default for new records
            if (Array.isArray(val)) return val.join(',');
            return String(val);
        });

        if (esActualizacion) {
            const currentRow = allData[fila - 1];
            const finalRow = rowData.map((v, i) => v === undefined ? currentRow[i] : v);
            sheet.getRange(fila, 1, 1, headers.length).setValues([finalRow]);
            return { success: true, message: "✅ Registro actualizado correctamente." };
        } else {
            sheet.appendRow(rowData);
            return { success: true, message: `✅ Creado exitosamente con ID: ${data[primaryKey]}` };
        }
    } catch (e) {
        Logger.log(e);
        return { success: false, message: "Error Servidor: " + e.message };
    }
}

/**
 * @function generarSiguienteId
 * @description Genera el siguiente ID secuencial para una hoja dada. Construye un ID basado en un prefijo predefinido (ej. 'EST' para estudiantes) y un número secuencial con ceros a la izquierda. Determina el ID actual escaneando la hoja para encontrar el valor máximo.
 * @param {string} sheetName El nombre de la hoja para la cual generar el ID.
 * @returns {string} El nuevo ID generado.
 */
function generarSiguienteId(sheetName) {
    const map = {};
    map[CONFIG.SHEETS.ESTUDIANTES] = ['EST', 'Siguiente_ID_Estudiante'];
    map[CONFIG.SHEETS.DOCENTES] = ['DOC', 'Siguiente_ID_Docente'];
    map[CONFIG.SHEETS.TESIS] = ['TES', 'Siguiente_ID_Tesis'];
    map[CONFIG.SHEETS.EVENTOS] = ['EVT', 'Siguiente_ID_Evento'];
    map[CONFIG.SHEETS.INSTITUCIONES] = ['INS', 'Siguiente_ID_Institucion'];
    map[CONFIG.SHEETS.EXTERNOS] = ['EXT', 'Siguiente_ID_Externo'];

    const conf = map[sheetName];
    if (!conf) return 'GEN-' + Date.now();

    // Robust ID generation: Find the maximum in the actual sheet + 1
    const prefix = conf[0];
    const sheet = obtenerHoja(sheetName);
    const data = sheet.getDataRange().getValues();
    let maxId = 0;
    for (let i = 1; i &lt; data.length; i++) {
        const celda = String(data[i][0]);
        if (celda.startsWith(prefix)) {
            const num = parseInt(celda.replace(prefix, ''), 10);
            if (!isNaN(num) &amp;&amp; num > maxId) maxId = num;
        }
    }
    return prefix + String(maxId + 1).padStart(4, '0');
}

/**
 * @function actualizarMasivo
 * @description Realiza una actualización masiva de múltiples registros en un módulo específico. Toma una lista de IDs y un diccionario de campos a actualizar. Normaliza los campos según el tipo.
 * @param {string} modulo Nombre del módulo (ej. 'ESTUDIANTE').
 * @param {Array&lt;string>} listaIds Array de IDs de los registros a actualizar.
 * @param {Object} datosAActualizar Objeto con los campos y nuevos valores a aplicar.
 * @returns {Object} Objeto que indica éxito o fallo y un mensaje.
 */
function actualizarMasivo(modulo, listaIds, datosAActualizar) {
    try {
        const mu = String(modulo).toUpperCase();
        let sheetKey;
        if (mu.startsWith('ESTUDIANTE')) sheetKey = 'ESTUDIANTES';
        else if (mu.startsWith('DOCENTE')) sheetKey = 'DOCENTES';
        else if (mu.startsWith('TESIS')) sheetKey = 'TESIS';
        else if (mu.startsWith('EVENTO')) sheetKey = 'EVENTOS';
        else if (mu.startsWith('INSTITUCION')) sheetKey = 'INSTITUCIONES';
        else if (mu.startsWith('EXTERNO')) sheetKey = 'EXTERNOS';
        else throw new Error(`Módulo ${modulo} no reconocido.`);

        const sheetName = CONFIG.SHEETS[sheetKey];
        const sheet = obtenerHoja(sheetName);
        const headers = getModuleHeaders(sheet);
        const data = sheet.getDataRange().getValues();

        const idsSet = new Set(listaIds.map(String));
        let actualizados = 0;

        for (let i = 1; i &lt; data.length; i++) {
            const idFila = String(data[i][0]).trim();
            if (idsSet.has(idFila)) {
                let huboCambio = false;
                for (const [key, valor] of Object.entries(datosAActualizar)) {
                    const colIndex = headers.indexOf(key);
                    if (colIndex !== -1 &amp;&amp; valor !== undefined &amp;&amp; valor !== null) {
                        // Apply normalization here as well
                        let valFinal = valor;
                        if (typeof valor === 'string') {
                            if (key.toLowerCase().includes('email')) valFinal = valor.toLowerCase().trim();
                            else if (!key.includes('Cohorte')) valFinal = formatearTextoCapital(valor);
                        }

                        sheet.getRange(i + 1, colIndex + 1).setValue(valFinal);
                        huboCambio = true;
                    }
                }
                if (huboCambio) {
                    const idxUpdate = headers.indexOf('Ultima_Actualizacion');
                    if (idxUpdate !== -1) sheet.getRange(i + 1, idxUpdate + 1).setValue(new Date());
                    actualizados++;
                }
            }
        }
        return { success: true, message: `✅ Se actualizaron ${actualizados} registros.` };
    } catch (e) {
        Logger.log(e);
        return { success: false, message: "Error masivo: " + e.message };
    }
}

/**
 * @function eliminarMasivo
 * @description Elimina múltiples registros de la hoja de un módulo específico. Itera desde abajo hacia arriba para eliminar filas de forma segura.
 * @param {string} mod Nombre del módulo (ej. 'ESTUDIANTE').
 * @param {Array&lt;string>} ids Array de IDs de los registros a eliminar.
 * @returns {Object} Objeto que indica éxito o fallo y un mensaje.
 */
function eliminarMasivo(mod, ids) {
    try {
        const mu = String(mod).toUpperCase();
        let sheetKey;
        if (mu.startsWith('ESTUDIANTE')) sheetKey = 'ESTUDIANTES';
        else if (mu.startsWith('DOCENTE')) sheetKey = 'DOCENTES';
        else if (mu.startsWith('TESIS')) sheetKey = 'TESIS';
        else if (mu.startsWith('EVENTO')) sheetKey = 'EVENTOS';
        else if (mu.startsWith('INSTITUCION')) sheetKey = 'INSTITUCIONES';
        else if (mu.startsWith('EXTERNO')) sheetKey = 'EXTERNOS';
        else throw new Error(`Módulo ${mod} no reconocido.`);

        const s = obtenerHoja(CONFIG.SHEETS[sheetKey]);
        const d = s.getDataRange().getValues();
        let count = 0;
        for (let i = d.length - 1; i >= 1; i--) { if (ids.includes(String(d[i][0]))) { s.deleteRow(i + 1); count++; } }
        return { success: true, message: `${count} registros eliminados.` };
    } catch (e) {
        Logger.log(e);
        return { success: false, message: e.message };
    }
}</code></pre></article></section><footer class="footer" id="PeOAagUepe"><div class="wrapper">SGD-MCS | Maestría en Ciencias Sociales | Universidad de Córdoba</div></footer></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><a href="/" class="sidebar-title sidebar-title-anchor">SGD-MCS Doc</a><div class="mobile-nav-links"></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#CONFIG">CONFIG</a></div><div class="sidebar-section-children"><a href="global.html#SPREADSHEET_ID">SPREADSHEET_ID</a></div><div class="sidebar-section-children"><a href="global.html#actualizarMasivo">actualizarMasivo</a></div><div class="sidebar-section-children"><a href="global.html#configurarHoja">configurarHoja</a></div><div class="sidebar-section-children"><a href="global.html#crearEstructuraCompleta">crearEstructuraCompleta</a></div><div class="sidebar-section-children"><a href="global.html#crearHojaConfiguracion">crearHojaConfiguracion</a></div><div class="sidebar-section-children"><a href="global.html#crearHojaDocentes">crearHojaDocentes</a></div><div class="sidebar-section-children"><a href="global.html#crearHojaEstudiantes">crearHojaEstudiantes</a></div><div class="sidebar-section-children"><a href="global.html#crearHojaEventos">crearHojaEventos</a></div><div class="sidebar-section-children"><a href="global.html#crearHojaExternos">crearHojaExternos</a></div><div class="sidebar-section-children"><a href="global.html#crearHojaInstituciones">crearHojaInstituciones</a></div><div class="sidebar-section-children"><a href="global.html#crearHojaTesis">crearHojaTesis</a></div><div class="sidebar-section-children"><a href="global.html#eliminarMasivo">eliminarMasivo</a></div><div class="sidebar-section-children"><a href="global.html#enriquecerDatosConNombres">enriquecerDatosConNombres</a></div><div class="sidebar-section-children"><a href="global.html#formatearEmail">formatearEmail</a></div><div class="sidebar-section-children"><a href="global.html#formatearNombrePropio">formatearNombrePropio</a></div><div class="sidebar-section-children"><a href="global.html#formatearTextoCapital">formatearTextoCapital</a></div><div class="sidebar-section-children"><a href="global.html#formatearTextoGeneral">formatearTextoGeneral</a></div><div class="sidebar-section-children"><a href="global.html#generarSiguienteId">generarSiguienteId</a></div><div class="sidebar-section-children"><a href="global.html#getDB">getDB</a></div><div class="sidebar-section-children"><a href="global.html#getModuleHeaders">getModuleHeaders</a></div><div class="sidebar-section-children"><a href="global.html#guardarDatos">guardarDatos</a></div><div class="sidebar-section-children"><a href="global.html#obtenerDatosHoja">obtenerDatosHoja</a></div><div class="sidebar-section-children"><a href="global.html#obtenerDatosIniciales">obtenerDatosIniciales</a></div><div class="sidebar-section-children"><a href="global.html#obtenerHoja">obtenerHoja</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>