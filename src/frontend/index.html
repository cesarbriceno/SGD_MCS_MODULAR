<!DOCTYPE html>
<html lang="es">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gestión MCS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <?!= include('src/frontend/css/styles'); ?>
</head>
<body>
  <div id="loader">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    <div class="mt-3 fw-bold text-secondary">Procesando...</div>
  </div>
  <div class="container main-card p-0">
    <div class="header-bar">
      <h4 class="m-0"><i class="fas fa-university me-2"></i>Gestión MCS</h4>
      <button class="btn btn-outline-light btn-sm" onclick="cargarTodosLosDatos()"><i class="fas fa-sync-alt me-1"></i> Actualizar</button>
    </div>
    <?!= include('src/frontend/components/nav'); ?>
    <?!= include('src/frontend/components/tables'); ?>
  </div>
  <?!= include('src/frontend/components/actions'); ?>
  <?!= include('src/frontend/components/modals'); ?>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    let moduloActual = 'estudiante';
    let datosGlobales = { estudiantes: [], docentes: [], tesis: [], eventos: [], instituciones: [], externos: [] };
    let seleccionados = new Set();

    /**
     * This function is responsible for fetching all data from the backend for all modules (students, teachers, theses, events, institutions, and external entities) and populating the global data store. It also handles displaying a loading spinner during the data fetching process and then renders the data into the appropriate tables.
     *
     * Pre-conditions:
     * - The `datosGlobales` object must be initialized.
     * - The `moduloActual` variable should be set to the initial active module (e.g., 'estudiante').
     * - The UI elements for the loader and tables should exist in the HTML.
     *
     * Post-conditions:
     * - `datosGlobales` will be populated with the latest data from the server.
     * - The loading spinner will be hidden.
     * - The active module's table will be rendered with the fetched data.
     * - Error messages will be displayed if any fetching operation fails.
     *
     * Side Effects:
     * - Modifies the `datosGlobales` object.
     * - Updates the visibility of the loader.
     * - Updates the content of the UI tables.
     * - May display SweetAlert2 popups for errors.
     */
    async function cargarTodosLosDatos() {
      document.getElementById('loader').classList.remove('d-none');
      try {
        datosGlobales.estudiantes = await google.script.run.withSuccessHandler(data => data).getEstudiantes();
        datosGlobales.docentes = await google.script.run.withSuccessHandler(data => data).getDocentes();
        datosGlobales.tesis = await google.script.run.withSuccessHandler(data => data).getTesis();
        datosGlobales.eventos = await google.script.run.withSuccessHandler(data => data).getEventos();
        datosGlobales.instituciones = await google.script.run.withSuccessHandler(data => data).getInstituciones();
        datosGlobales.externos = await google.script.run.withSuccessHandler(data => data).getExternos();
        renderizarTablaActual();
      } catch (error) {
        console.error('Error al cargar todos los datos:', error);
        Swal.fire('Error', 'No se pudieron cargar los datos. Intente de nuevo más tarde.', 'error');
      } finally {
        document.getElementById('loader').classList.add('d-none');
      }
    }

    /**
     * This function sets up global event listeners that are active across the application. Specifically, it listens for clicks on navigation tabs to change the currently active module and re-render the corresponding table.
     *
     * Pre-conditions:
     * - Navigation tabs with the class `nav-link` and a `data-modulo` attribute must exist in the HTML.
     *
     * Post-conditions:
     * - Click listeners are attached to all navigation tabs.
     * - Clicking a tab will update `moduloActual` and call `renderizarTablaActual()`.
     *
     * Side Effects:
     * - Modifies the `moduloActual` variable.
     * - Triggers a re-render of the table via `renderizarTablaActual()`.
     */
    function configurarListenersGlobales() {
      document.querySelectorAll('.nav-link[data-modulo]').forEach(item => {
        item.addEventListener('click', event => {
          moduloActual = event.target.dataset.modulo;
          renderizarTablaActual();
        });
      });
    }

    window.onload = function() { cargarTodosLosDatos(); configurarListenersGlobales(); };
  </script>
  <?!= include('src/frontend/js/utils'); ?>
  <?!= include('src/frontend/js/render'); ?>
  <?!= include('src/frontend/js/forms'); ?>
  <?!= include('src/frontend/js/export'); ?>
</body>
</html>