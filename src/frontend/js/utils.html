<script>
    // ✅ ESTA ES LA FUNCIÓN QUE TE FALTABA
    function cargarTodosLosDatos() {
       mostrarLoader(true);
       google.script.run.withSuccessHandler(res => {
           if(res.success) {
               datosGlobales = res.data;
               // Verificamos que las funciones de render existan antes de ejecutarlas
               if(typeof renderEstudiantes === 'function') renderEstudiantes(datosGlobales.estudiantes);
               if(typeof renderDocentes === 'function') renderDocentes(datosGlobales.docentes);
               if(typeof renderExternos === 'function') renderExternos(datosGlobales.externos); // Nuevo módulo
               if(typeof renderTesis === 'function') renderTesis(datosGlobales.tesis);
               if(typeof renderEventos === 'function') renderEventos(datosGlobales.eventos);
               if(typeof renderInstituciones === 'function') renderInstituciones(datosGlobales.instituciones);
           }
           mostrarLoader(false);
       }).obtenerDatosIniciales();
    }

    // --- RESTO DE TUS FUNCIONES (YA ESTABAN BIEN) ---
    function toggleReingreso() { const s=document.getElementById('reingresoSi').checked; const d=document.getElementById('div-est-reingreso'); if(s){d.style.display='block';} else{d.style.display='none';} }
    function toggleEstadoEstudiante() { const v=val('est-estado'); document.getElementById('div-est-graduado').style.display=v==='Graduado'?'block':'none'; document.getElementById('div-est-retirado').style.display=v==='Retirado'?'block':'none'; }
    function toggleDocenteActivo() { const d = document.getElementById('div-doc-desvinculacion'); if(val('doc-activo')==='No') { d.style.display='block'; } else { d.style.display='none'; } }
    function val(id){ return document.getElementById(id) ? document.getElementById(id).value : ''; }
    function setVal(id,v){ if(document.getElementById(id)) document.getElementById(id).value=v||''; }
    function gestionarSeleccion(id){ if(seleccionados.has(id)) seleccionados.delete(id); else seleccionados.add(id); updateBarra(); }
    function toggleSeleccionarTodo(el,id){ document.querySelectorAll(`#${id} .row-checkbox`).forEach(c=>{ c.checked=el.checked; el.checked?seleccionados.add(c.value):seleccionados.delete(c.value); }); updateBarra(); }
    function deseleccionarTodo(){ seleccionados.clear(); document.querySelectorAll('.row-checkbox').forEach(c=>c.checked=false); updateBarra(); }
    function updateBarra(){ document.getElementById('contador-seleccion').innerText=seleccionados.size; const b=document.querySelector('.floating-action-bar'); seleccionados.size>0?b.classList.add('visible'):b.classList.remove('visible'); }
    function validarInput(input, tipo) { let esValido = true; if (input.hasAttribute('required') && input.value.trim() === '') esValido = false; if (tipo === 'numero') input.value = input.value.replace(/\D/g, ''); if (tipo === 'email' && input.value.length > 0 && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(input.value)) esValido = false; input.classList.toggle('is-invalid', !esValido); input.classList.toggle('is-valid', esValido); }
    function mostrarLoader(v){ document.getElementById('loader').style.display=v?'flex':'none'; }
    function filtrarTabla(id,t){ const v=t.toLowerCase(); document.querySelectorAll(`#${id}-body tr`).forEach(r=>{ const txt = r.innerText.toLowerCase(); const search = r.getAttribute('data-search')||''; r.style.display=(txt.includes(v)||search.includes(v))?'':'none'; }); }
    function cb(res){ mostrarLoader(false); if(res.success){ Swal.fire('Listo',res.message,'success'); document.querySelectorAll('.modal').forEach(m => { const instance = bootstrap.Modal.getInstance(m); if (instance) instance.hide(); }); cargarTodosLosDatos(); deseleccionarTodo(); } else Swal.fire('Error',res.message,'error'); }
    function err(e) { mostrarLoader(false); Swal.fire('Error de Sistema', e.message, 'error'); }
    function configurarListenersGlobales() { document.querySelectorAll('form').forEach(f => f.addEventListener('submit', e => { e.preventDefault(); enviarFormulario(f.id); })); }
    
    function getCheck(id) { return `<input type="checkbox" class="row-checkbox" value="${id}" onchange="gestionarSeleccion('${id}')">`; }
    function getBotonesAccion(mod, id) { 
        return `<div class="btn-group"><button class="btn btn-sm btn-light border text-info" onclick="verDetalle('${mod}','${id}')"><i class="fas fa-eye"></i></button><button class="btn btn-sm btn-light border text-primary" onclick="editarIndividual('${mod}','${id}')"><i class="fas fa-pen"></i></button><button class="btn btn-sm btn-light border text-danger" onclick="eliminarIndividual('${mod}','${id}')"><i class="fas fa-trash"></i></button></div>`; 
    }
    function setModulo(mod) { moduloActual = mod; deseleccionarTodo(); }
</script>